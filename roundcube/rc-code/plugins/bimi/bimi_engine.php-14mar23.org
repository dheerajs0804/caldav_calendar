<?php

/**
 * @license GNU GPLv3+
 * @author Craig Andrews <candrews@integralblue.com>
 */
class bimi_engine
{
    //private string $email;
    private $email;
    //private string $binary;
    private $binary;

    static private $debug = true;

    const MIME_TYPE = 'image/svg+xml';
    const CACHE_MISS_VALUE = 'NOT FOUND';

    /**
     * Class constructor
     *
     * @param string $email   email address
     */
    public function __construct($email)
    {
	if(self::$debug === null) {
                self::$debug = $this->rc->config->get('bimi_debug');
        }

        $this->email  = $email;
        $this->retrieve();
    }

    /**
     * Returns image mimetype
     */
    public function getMimetype()
    {
        return self::MIME_TYPE;
    }

    /**
     * Returns the image in binary form
     */
    public function getBinary()
    {
        return $this->binary;
    }

    /**
     * Sends the image to the browser
     */
    public function sendOutput()
    {
	self::debug_log("Start sendOutput.");

        if ($this->binary) {
	    self::debug_log("Binary output available : ".$this->binary);

            $rcmail = rcmail::get_instance();
            $rcmail->output->future_expire_header(10 * 60);

            header('Content-Type: ' . self::MIME_TYPE);
            header('Content-Size: ' . strlen($this->binary));
            echo $this->binary;

            return true;
        }
	else
	{
		self::debug_log("Binary output not available");
	}

        return false;
    }

    /**
     * BIMI retriever
     */
    private function retrieve()
    {
        $domain = explode("@",$this->email);
	if(sizeof($domain) >= 2){
            $domain = $domain[sizeof($domain)-1];
	    $this->binary = $this->cache_get_bimi_image($domain);
	}
	else {
	    $this->binary = null;
	}
    }

    /**
     * Using the cache, given a domain, returns the BIMI image. The image is always SVG XML. Returns null if no image could be retrieved.
     */
    private function cache_get_bimi_image(string $domain): string
    {
        $rcmail = rcmail::get_instance();
	$cache = $rcmail->get_cache_shared('bimi');
	if ($cache && $cached_data=$cache->get($domain)) {
	    if($cached_data==self::CACHE_MISS_VALUE) {
	        return null;
            }
	    else {
	        return $cached_data;
	    }
        }
	else {
            $data = $this->get_bimi_image($domain);
            if($data == null) {
	        $cached_data=self::CACHE_MISS_VALUE;
	    }
	    if ($cache) {
	        $cache->set($domain, $cached_data);
            }
	    return $data;
	}
    }

    /**
     * Given a domain, returns the BIMI image. The image is always SVG XML. Returns null if no image could be retrieved.
     */
    private function get_bimi_image(string $domain): string
    {
        if($bimi_url = $this->get_bimi_url($domain)) {

		echo "bimi url = ".$bimi_url ;
	    $rcmail = rcmail::get_instance();
	    //$client = $rcmail->get_http_client();

	    //$client = new \GuzzleHttp\Client(); 	

	   /* $res = $client->request('GET', $bimi_url);
	    if ( $res->getStatusCode() == 200 && $res->hasHeader('Content-Type') && strcasecmp($res->getHeader('Content-Type')[0], self::MIME_TYPE) == 0) {
		$svg = $res->getBody()->getContents();
		$svg = rcmail_attachment_handler::svg_filter($svg);
		return $svg;
	    }*/

	    // Initialize a CURL session.
	    $ch = curl_init();

	    // Return Page contents.
	    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

	   //grab URL and pass it to the variable.
           curl_setopt($ch, CURLOPT_URL, $bimi_url);
  	
	   $result = curl_exec($ch);	

		echo "bimi svg = ".$result ;
		
	   return $result ; 	
	}
	//return null;
	return "";
    }

    /**
     * Given a domain, returns the BIMI URL or null if there no such domain or the domain doesn't have a BIMI record.
     */
    private function get_bimi_url(string $domain): string
    {
        $bimi_record = dns_get_record("default._bimi.".$domain, DNS_TXT);
	if($bimi_record && sizeof($bimi_record) >= 1 && array_key_exists('txt', $bimi_record[0])){
	    $bimi_record_value = $bimi_record[0]['txt'];
	    if(preg_match('@v=BIMI1(?:;|$)@i', $bimi_record_value, $svg) && preg_match('@l=(https://.+?)(?:;|$)@', $bimi_record_value, $matches)){
	        $bimi_url = $matches[1];
		return $bimi_url;
	    }
	}
	//return null;
	return "";
    }

    static private function debug_log($message) {

        rcmail::console(__CLASS__.': '.self::$debug) ;

        if(self::$debug === true) {
            rcmail::console(__CLASS__.': '.$message);
        }
        else
        {
                rcmail::console(__CLASS__.': Debug is false') ;
        }
    }
}
